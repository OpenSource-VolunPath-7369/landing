<div class="mensajes-container min-h-screen bg-gray-50">
  <!-- Título de la sección -->
  <div class="mb-6" style="padding-bottom: 20px; border-bottom: 2px solid rgba(14, 165, 233, 0.1);">
    <h1 class="mensajes-title">{{ 'messages.title' | translate }}</h1>
    <div *ngIf="unreadCount > 0" class="mt-2">
      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
        {{ unreadCount }} {{ unreadCount > 1 ? ('messages.unreadCountPlural' | translate) : ('messages.unreadCount' | translate) }}
      </span>
    </div>
  </div>

  <!-- Acciones (siempre visible cuando no hay formulario ni mensaje seleccionado) -->
  <div class="mb-6 flex flex-col sm:flex-row gap-3" *ngIf="!showSendForm && !selectedMessage">
    <button 
      (click)="toggleSendForm()" 
      class="send-message-button">
      <mat-icon>send</mat-icon>
      <span>{{ isVolunteerMode ? ('messages.sendToOrganizations' | translate) : ('messages.sendToVolunteers' | translate) }}</span>
    </button>
    <button 
      *ngIf="unreadCount > 0"
      (click)="markAllAsRead()" 
      class="inline-flex items-center justify-center px-5 py-2.5 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 shadow-sm">
      <svg class="-ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
      {{ 'messages.markAllRead' | translate }}
    </button>
  </div>

  <!-- Estados de carga y error -->
  <div *ngIf="loading" class="flex justify-center items-center py-12">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
      <p class="mt-4 text-gray-600">{{ 'messages.loading' | translate }}</p>
    </div>
  </div>

  <div *ngIf="error && !loading" class="text-center py-12">
    <div class="text-red-600 mb-4">
      <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 19.5c-.77.833.192 2.5 1.732 2.5z" />
      </svg>
    </div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">{{ 'messages.errorLoading' | translate }}</h3>
    <p class="text-gray-600 mb-4">{{ error }}</p>
    <button 
      (click)="retry()" 
      class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
      <svg class="-ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
      {{ 'common.retry' | translate }}
    </button>
  </div>

  <!-- Layout principal: Formulario de envío y Lista de mensajes -->
  <div *ngIf="!loading && !error" class="flex flex-col space-y-6">
    
    <!-- Formulario de Envío de Mensajes -->
    <mat-card class="send-message-card" *ngIf="showSendForm">
      <mat-card-header>
        <div class="flex justify-between items-center w-full">
          <h2 class="text-lg font-semibold text-gray-900">
            {{ isVolunteerMode ? ('messages.sendToOrganizations' | translate) : ('sendMessage.title' | translate) }}
          </h2>
          <button mat-icon-button (click)="toggleSendForm()" [title]="'common.close' | translate">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </mat-card-header>
      
      <mat-card-content>
        <!-- Error Message -->
        <div *ngIf="error" class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <div class="flex items-center">
            <svg class="h-5 w-5 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="text-red-800 font-medium">{{ error }}</p>
          </div>
        </div>

        <form [formGroup]="messageForm" (ngSubmit)="sendMessageToRecipients()">
          <!-- Subject -->
          <mat-form-field appearance="fill" class="full-width">
            <mat-label>{{ 'sendMessage.subject' | translate }}</mat-label>
            <input matInput formControlName="subject">
            <mat-error *ngIf="messageForm.get('subject')?.hasError('required')">
              {{ 'sendMessage.subjectRequired' | translate }}
            </mat-error>
            <mat-error *ngIf="messageForm.get('subject')?.hasError('minlength')">
              {{ 'sendMessage.subjectMinLength' | translate }}
            </mat-error>
          </mat-form-field>

          <!-- Content -->
          <mat-form-field appearance="fill" class="full-width">
            <mat-label>{{ 'sendMessage.message' | translate }}</mat-label>
            <textarea matInput formControlName="content" 
                      rows="3"></textarea>
            <mat-error *ngIf="messageForm.get('content')?.hasError('required')">
              {{ 'sendMessage.messageRequired' | translate }}
            </mat-error>
            <mat-error *ngIf="messageForm.get('content')?.hasError('minlength')">
              {{ 'sendMessage.messageMinLength' | translate }}
            </mat-error>
          </mat-form-field>

          <!-- URL -->
          <mat-form-field appearance="fill" class="full-width">
            <mat-label>{{ 'sendMessage.url' | translate }}</mat-label>
            <input matInput formControlName="url" 
                   type="url">
            <mat-hint>{{ 'sendMessage.urlHint' | translate }}</mat-hint>
            <mat-error *ngIf="messageForm.get('url')?.hasError('pattern')">
              {{ 'sendMessage.urlInvalid' | translate }}
            </mat-error>
          </mat-form-field>

          <!-- Recipients Selection (Volunteers or Organizations) -->
          <div class="volunteers-section">
            <div class="volunteers-header">
              <h3 class="section-title">
                {{ isVolunteerMode ? ('messages.selectRecipients' | translate) : ('sendMessage.selectVolunteers' | translate) }}
              </h3>
              <button type="button" mat-button (click)="selectAllRecipients()" class="select-all-button">
                {{ allRecipientsSelected ? ('sendMessage.deselectAll' | translate) : ('sendMessage.selectAll' | translate) }}
              </button>
            </div>
            
            <div class="selected-count">
              <span *ngIf="selectedCount > 0" class="count-badge">
                {{ selectedCount }} {{ isVolunteerMode ? ('community.organizations' | translate) : ('sendMessage.volunteersSelected' | translate) }}{{ selectedCount > 1 ? (isVolunteerMode ? '' : 's') : '' }} {{ 'common.selected' | translate }}
              </span>
              <span *ngIf="selectedCount === 0" class="count-badge empty">
                {{ 'sendMessage.noVolunteerSelected' | translate }}
              </span>
            </div>

            <!-- Lista de Voluntarios (para organizaciones) -->
            <div class="volunteers-list" *ngIf="!isVolunteerMode">
              <div *ngFor="let volunteer of volunteers" 
                   class="volunteer-item"
                   (click)="toggleRecipientSelection(volunteer.id)">
                <mat-checkbox 
                  [checked]="isRecipientSelected(volunteer.id)"
                  (change)="toggleRecipientSelection(volunteer.id)"
                  (click)="$event.stopPropagation()">
                </mat-checkbox>
                <img [src]="volunteer.avatar || '/assets/andrea.png'" 
                     [alt]="volunteer.name"
                     class="volunteer-avatar">
                <div class="volunteer-info">
                  <div class="volunteer-name">{{ volunteer.name }}</div>
                  <div class="volunteer-email">
                    <mat-icon class="contact-icon">email</mat-icon>
                    {{ volunteer.email }}
                  </div>
                  <div *ngIf="volunteer.location" class="volunteer-location">
                    <mat-icon class="location-icon">location_on</mat-icon>
                    {{ volunteer.location }}
                  </div>
                  <div *ngIf="volunteer.skills && volunteer.skills.length > 0" class="volunteer-skills">
                    <mat-icon class="skills-icon">star</mat-icon>
                    <span *ngFor="let skill of volunteer.skills.slice(0, 3); let last = last">
                      {{ skill }}<span *ngIf="!last">, </span>
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Lista de Organizaciones (para voluntarios) -->
            <div class="volunteers-list" *ngIf="isVolunteerMode">
              <div *ngFor="let organization of organizations" 
                   class="volunteer-item"
                   (click)="toggleRecipientSelection(organization.id)">
                <mat-checkbox 
                  [checked]="isRecipientSelected(organization.id)"
                  (change)="toggleRecipientSelection(organization.id)"
                  (click)="$event.stopPropagation()">
                </mat-checkbox>
                <img [src]="organization.logo || '/assets/mundo.png'" 
                     [alt]="organization.name"
                     class="volunteer-avatar">
                <div class="volunteer-info">
                  <div class="volunteer-name">{{ organization.name }}</div>
                  <div class="volunteer-email">
                    <mat-icon class="contact-icon">email</mat-icon>
                    {{ organization.email }}
                  </div>
                  <div *ngIf="organization.address" class="volunteer-location">
                    <mat-icon class="location-icon">location_on</mat-icon>
                    {{ organization.address }}
                  </div>
                  <div *ngIf="organization.categories && organization.categories.length > 0" class="volunteer-skills">
                    <mat-icon class="skills-icon">category</mat-icon>
                    <span *ngFor="let category of organization.categories.slice(0, 3); let last = last">
                      {{ category }}<span *ngIf="!last">, </span>
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="availableRecipients.length === 0" class="empty-volunteers">
              <p class="text-gray-500">{{ isVolunteerMode ? ('community.organizations' | translate) : ('sendMessage.noVolunteersAvailable' | translate) }}</p>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="form-actions">
            <button mat-button type="button" (click)="toggleSendForm()" [disabled]="sending">
              {{ 'common.cancel' | translate }}
            </button>
            <button mat-raised-button 
                    color="primary" 
                    type="submit"
                    [disabled]="sending || selectedCount === 0 || !messageForm.valid">
              <mat-icon *ngIf="!sending">send</mat-icon>
              <mat-icon *ngIf="sending" class="animate-spin">refresh</mat-icon>
              {{ sending ? ('sendMessage.sending' | translate) : (('sendMessage.sendTo' | translate) + ' ' + selectedCount + ' ' + (isVolunteerMode ? ('community.organizations' | translate) : ('sendMessage.volunteersSelected' | translate))) }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Lista de mensajes y acciones (solo cuando el formulario está oculto) -->
    <div *ngIf="!showSendForm" class="flex flex-col lg:flex-row lg:gap-6">
      <!-- Lista de mensajes -->
      <div class="w-full" [ngClass]="{'lg:w-1/3 lg:max-w-md': selectedMessage, 'lg:w-1/2': !selectedMessage}">
        <app-message-list [messages]="messages" [highlightSender]="highlightSender" (messageClick)="onMessageClick($event)"></app-message-list>
      </div>

      <!-- Vista del mensaje seleccionado -->
      <div class="w-full lg:w-2/3 mt-6 lg:mt-0" *ngIf="selectedMessage">
        <div class="bg-white rounded-lg shadow-lg p-6 message-view-container">
          <!-- Header del mensaje -->
          <div class="message-view-header">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold text-gray-900">{{ 'messages.title' | translate }}</h2>
              <button mat-icon-button (click)="closeMessageView()" [title]="'common.close' | translate">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            
            <!-- Información del remitente -->
            <div class="message-sender-info-view">
              <img [src]="selectedMessage.senderIcon" 
                   [alt]="selectedMessage.senderName" 
                   class="sender-avatar-view"
                   onerror="this.src='/assets/mundo.png'">
              <div class="sender-details-view">
                <h3 class="sender-name-view">
                  {{ selectedMessage.senderName }}
                  <span *ngIf="selectedMessage.senderOrganization" class="organization-name">
                    ({{ selectedMessage.senderOrganization }})
                  </span>
                </h3>
                <p class="message-date-view">{{ selectedMessage.timestamp | date:'medium' }}</p>
              </div>
            </div>
          </div>
          
          <!-- Contenido del mensaje -->
          <div class="message-content-view">
            <p class="message-text-view">{{ selectedMessage.content }}</p>
          </div>
          
          <!-- Formulario de respuesta -->
          <div class="reply-section-view">
            <h4 class="reply-title-view">{{ 'messages.reply' | translate }}</h4>
            <form [formGroup]="replyForm" (ngSubmit)="sendReply()">
              <mat-form-field appearance="fill" class="full-width">
                <mat-label>{{ 'messages.contentPlaceholder' | translate }}</mat-label>
                <textarea matInput 
                          formControlName="content" 
                          rows="4"></textarea>
                <mat-error *ngIf="replyForm.get('content')?.hasError('required')">
                  {{ 'sendMessage.messageRequired' | translate }}
                </mat-error>
              </mat-form-field>
              
              <div class="reply-actions-view">
                <button mat-button 
                        type="button" 
                        (click)="closeMessageView()"
                        [disabled]="sendingReply">
                  {{ 'common.cancel' | translate }}
                </button>
                <button mat-raised-button 
                        color="primary" 
                        type="submit"
                        [disabled]="replyForm.invalid || sendingReply">
                  <span *ngIf="!sendingReply">{{ 'messages.reply' | translate }}</span>
                  <span *ngIf="sendingReply">
                    <mat-icon class="animate-spin">refresh</mat-icon>
                    {{ 'messages.sending' | translate }}
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

