<div class="form-container">
  <div class="form-header">
    <h1 class="form-title">{{ isEditMode ? ('publication.edit' | translate) : ('publication.new' | translate) }}</h1>
    <p class="form-subtitle">{{ isEditMode ? ('publication.editSubtitle' | translate) : ('publication.newSubtitle' | translate) }}</p>
  </div>

  <!-- Estados de carga y error -->
  <div *ngIf="loading" class="flex justify-center items-center py-12">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
      <p class="mt-4 text-gray-600">{{ 'publication.loadingOrganizations' | translate }}</p>
    </div>
  </div>

  <div *ngIf="error && loading" class="text-center py-12">
    <div class="text-red-600 mb-4">
      <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 19.5c-.77.833.192 2.5 1.732 2.5z" />
      </svg>
    </div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">{{ 'publication.errorLoadingOrganizations' | translate }}</h3>
    <p class="text-gray-600 mb-4">{{ error }}</p>
    <button 
      (click)="retry()" 
      class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
      <svg class="-ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
      {{ 'common.retry' | translate }}
    </button>
  </div>

  <!-- Mensaje de error del formulario -->
  <div *ngIf="error && !loading" class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
    <div class="flex items-center">
      <svg class="h-5 w-5 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <p class="text-red-800 font-medium">{{ error }}</p>
    </div>
  </div>

  <mat-card class="publication-form" *ngIf="!loading && !error">
    <mat-card-content>
      <form [formGroup]="publicationForm" (ngSubmit)="onSubmit()">
        <!-- Título -->
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>{{ 'publication.title' | translate }}</mat-label>
          <input matInput formControlName="title">
          <mat-error *ngIf="publicationForm.get('title')?.hasError('required')">
            {{ 'publication.titleRequired' | translate }}
          </mat-error>
          <mat-error *ngIf="publicationForm.get('title')?.hasError('minlength')">
            El título debe tener al menos 5 caracteres
          </mat-error>
        </mat-form-field>

        <!-- Descripción -->
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>{{ 'publication.description' | translate }}</mat-label>
          <textarea matInput formControlName="description" 
                    rows="3"></textarea>
          <mat-error *ngIf="publicationForm.get('description')?.hasError('required')">
            {{ 'publication.descriptionRequired' | translate }}
          </mat-error>
          <mat-error *ngIf="publicationForm.get('description')?.hasError('minlength')">
            La descripción debe tener al menos 20 caracteres
          </mat-error>
        </mat-form-field>

        <!-- Imagen -->
        <div class="image-upload-section">
          <input
            type="file"
            id="image"
            (change)="onImageSelected($event)"
            accept="image/*"
            class="file-input">
          
          <div class="image-upload-controls">
            <button mat-raised-button color="primary" type="button" (click)="selectImage()" 
                    class="select-image-button">
              <mat-icon>camera_alt</mat-icon>
              {{ 'publication.selectImage' | translate }}
            </button>
            <p class="image-upload-hint">
              {{ 'publication.imageFormats' | translate }}
            </p>
          </div>
          
          <!-- Preview de imagen -->
          <div *ngIf="imagePreview" class="image-preview">
            <img [src]="imagePreview" alt="Preview" class="preview-image">
            <button mat-icon-button color="warn" type="button" (click)="removeImage()" class="remove-image-btn">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>

        <!-- Organización -->
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>{{ 'publication.organization' | translate }}</mat-label>
          <mat-select formControlName="organizationId">
            <mat-option *ngIf="organizations.length === 0" disabled>
              {{ 'publication.noOrganizationsAvailable' | translate }}
            </mat-option>
            <mat-option *ngFor="let org of organizations" [value]="org.id">
              {{ org.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="publicationForm.get('organizationId')?.hasError('required') && publicationForm.get('organizationId')?.touched">
            {{ 'publication.organizationRequired' | translate }}
          </mat-error>
          <mat-hint *ngIf="organizations.length === 0" class="text-red-600">
            {{ 'publication.organizationLoadError' | translate }}
          </mat-hint>
        </mat-form-field>

        <!-- Tags -->
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>{{ 'publication.tags' | translate }}</mat-label>
          <input matInput formControlName="tags">
          <mat-hint>{{ 'publication.tagsHint' | translate }}</mat-hint>
        </mat-form-field>

        <!-- Configuraciones adicionales -->
        <div class="checkbox-section">
          <mat-checkbox formControlName="isPublic">
            {{ 'publication.makePublic' | translate }}
          </mat-checkbox>
          <p class="checkbox-hint">
            {{ 'publication.publicHint' | translate }}
          </p>
        </div>

        <!-- Fecha y Hora lado a lado -->
        <div class="date-time-row">
          <!-- Fecha programada -->
          <mat-form-field appearance="fill" class="half-width">
            <mat-label>{{ 'publication.scheduledDate' | translate }}</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="scheduledDate" [required]="true">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error *ngIf="publicationForm.get('scheduledDate')?.hasError('required')">
              {{ 'publication.dateRequired' | translate }}
            </mat-error>
            <mat-error *ngIf="publicationForm.get('scheduledDate')?.hasError('pastDate')">
              La fecha debe ser mayor o igual a la actual
            </mat-error>
          </mat-form-field>

          <!-- Hora -->
          <mat-form-field appearance="fill" class="half-width">
            <mat-label>{{ 'publication.time' | translate }}</mat-label>
            <input matInput type="time" formControlName="time">
            <mat-error *ngIf="publicationForm.get('time')?.hasError('required')">
              {{ 'publication.timeRequired' | translate }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Lugar y Cantidad máxima de voluntarios lado a lado -->
        <div class="date-time-row">
          <!-- Lugar -->
          <mat-form-field appearance="fill" class="half-width">
            <mat-label>{{ 'publication.location' | translate }}</mat-label>
            <input matInput formControlName="location">
            <mat-error *ngIf="publicationForm.get('location')?.hasError('required')">
              {{ 'publication.locationRequired' | translate }}
            </mat-error>
          </mat-form-field>

          <!-- Cantidad máxima de voluntarios -->
          <mat-form-field appearance="fill" class="half-width">
            <mat-label>{{ 'publication.maxVolunteers' | translate }}</mat-label>
            <input matInput type="number" formControlName="maxVolunteers" min="1">
            <mat-error *ngIf="publicationForm.get('maxVolunteers')?.hasError('required')">
              {{ 'publication.maxVolunteersRequired' | translate }}
            </mat-error>
            <mat-error *ngIf="publicationForm.get('maxVolunteers')?.hasError('min')">
              {{ 'publication.maxVolunteersMin' | translate }}
            </mat-error>
          </mat-form-field>
        </div>
      </form>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-button type="button" (click)="onCancel()" [disabled]="submitting">
        <mat-icon>arrow_back</mat-icon>
        {{ 'common.cancel' | translate }}
      </button>
      <button mat-raised-button color="primary" 
              type="button"
              [disabled]="submitting"
              (click)="onSubmit()">
        <mat-icon *ngIf="!submitting">{{ isEditMode ? 'save' : 'publish' }}</mat-icon>
        <mat-icon *ngIf="submitting" class="animate-spin">refresh</mat-icon>
        {{ submitting ? (isEditMode ? ('publication.saving' | translate) : ('publication.creating' | translate)) : (isEditMode ? ('publication.saveChanges' | translate) : ('publication.createPublication' | translate)) }}
      </button>
    </mat-card-actions>
  </mat-card>
</div>
